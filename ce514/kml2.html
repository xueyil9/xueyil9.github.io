<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CE514 KML Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        #map {
            height: 600px;
            width: 100%;
            margin-bottom: 20px;
        }
        .info-content {
            padding: 10px;
            max-width: 300px;
        }
        .info-content h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .custom-div-icon {
            background: none;
            border: none;
        }
        .marker-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .marker-icon i {
            font-size: 24px;
        }
        .college-icon i { color: #4CAF50; }
        .home-icon i { color: #2196F3; }
        .work-icon i { color: #F44336; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

    <script>
        const map = L.map('map').setView([33, 119], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Custom icons using Font Awesome
        const createCustomIcon = (iconClass, colorClass) => {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div class="marker-icon ${colorClass}">
                         <i class="${iconClass}"></i>
                       </div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20],
                popupAnchor: [0, -20]
            });
        };

        const icons = {
            'Colledge': createCustomIcon('fas fa-graduation-cap', 'college-icon'),
            'Home': createCustomIcon('fas fa-home', 'home-icon'),
            'work': createCustomIcon('fas fa-briefcase', 'work-icon')
        };

        // Load and process points from xyreal.kml
        fetch('xyreal.kml')
            .then(res => res.text())
            .then(kmltext => {
                const parser = new DOMParser();
                const kml = parser.parseFromString(kmltext, 'text/xml');
                const placemarks = kml.getElementsByTagName('Placemark');

                Array.from(placemarks).forEach(placemark => {
                    const coords = placemark.getElementsByTagName('coordinates')[0].textContent.trim().split(',');
                    const description = placemark.getElementsByTagName('SimpleData')[1].textContent;

                    const marker = L.marker([parseFloat(coords[1]), parseFloat(coords[0])], {
                        icon: icons[description] || icons['Home']
                    });

                    const popupContent = `
                        <div class="info-content">
                            <h3>${description}</h3>
                            <p>Location: ${coords[1]}, ${coords[0]}</p>
                        </div>
                    `;

                    marker.bindPopup(popupContent);
                    marker.addTo(map);
                });
            })
            .catch(error => console.error('Error loading points KML:', error));

        // Load and process polygon from huaian.kml
        fetch('huaian.kml')
            .then(res => res.text())
            .then(kmltext => {
                const parser = new DOMParser();
                const kml = parser.parseFromString(kmltext, 'text/xml');
                const placemarks = kml.getElementsByTagName('Placemark');

                Array.from(placemarks).forEach(placemark => {
                    const coordinates = placemark.getElementsByTagName('coordinates')[0].textContent
                        .trim()
                        .split(' ')
                        .filter(coord => coord.length > 0)
                        .map(coord => {
                            const [lng, lat] = coord.split(',');
                            return [parseFloat(lat), parseFloat(lng)];
                        });

                    const polygon = L.polygon(coordinates, {
                        color: '#ff4444',
                        weight: 2,
                        opacity: 0.8,
                        fillColor: '#ff8800',
                        fillOpacity: 0.2
                    });

                    const nameElements = placemark.getElementsByTagName('SimpleData');
                    let regionName = 'Region';
                    for (let el of nameElements) {
                        if (el.getAttribute('name') === 'ADM2_EN') {
                            regionName = el.textContent;
                            break;
                        }
                    }

                    const popupContent = `
                        <div class="info-content">
                            <h3>${regionName}</h3>
                            <p>Administrative Region</p>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    polygon.addTo(map);
                });
            })
            .catch(error => console.error('Error loading polygon KML:', error));
    </script>
</body>
</html>